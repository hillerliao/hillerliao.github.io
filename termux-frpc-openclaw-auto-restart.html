<!DOCTYPE html>
<html lang="zh" prefix="og: http://ogp.me/ns#">
	<head>
		<link href="http://gmpg.org/xfn/11" rel="profile">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta http-equiv="content-type" content="text/html; charset=utf-8">

		<!-- Metadata -->
	<meta name="description" content="利用 Termux 生态中的 termux:boot、termux-wake-lock、tmux 和 cron 组合，实现手机重启后服务自动启动、进程崩溃后自动检测并重启。">
	<meta property="og:description" content="利用 Termux 生态中的 termux:boot、termux-wake-lock、tmux 和 cron 组合，实现手机重启后服务自动启动、进程崩溃后自动检测并重启。">
	<meta property="og:title" content="Termux 环境下 frpc 和 OpenClaw 服务保活方案" />
	<meta property="og:type" content="article" />
	<meta property="og:url" content="https://hillerliao.github.io/termux-frpc-openclaw-auto-restart.html" />
		<meta property="og:image" content="https://hillerliao.github.io/images/avatar.jpg" />

		<!-- Enable responsiveness on mobile devices-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

		<title>Termux 环境下 frpc 和 OpenClaw 服务保活方案 - 互联网产品折腾师</title>

		<!-- CSS -->
		<link href="//fonts.googleapis.com/" rel="dns-prefetch">
		<link href="//fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic|Abril+Fatface|PT+Sans:400,400italic,700&amp;subset=latin,latin-ext" rel="stylesheet">

		<link rel="stylesheet" href="https://hillerliao.github.io/theme/css/poole.css" />
		<link rel="stylesheet" href="https://hillerliao.github.io/theme/css/hyde.css" />
		<link rel="stylesheet" href="https://hillerliao.github.io/theme/css/syntax.css" />
			<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.1.7/css/fork-awesome.min.css" crossorigin="anonymous">

		<!-- Feeds -->
<link href="https://hillerliao.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="廖智海 Full Atom Feed" />
<link href="https://hillerliao.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="廖智海 Full RSS Feed" />
<link href="https://hillerliao.github.io/feeds/blog.atom.xml" type="application/atom+xml" rel="alternate" title="廖智海 Categories Atom Feed" />

		<!-- Analytics -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-79917414-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-79917414-1');
</script>
	</head>

	<body class="theme-base-0d">
<div class="sidebar">
	<div class="container sidebar-sticky">
		<div class="sidebar-about">

			<h1>
				<a href="https://hillerliao.github.io/">
					<img class="profile-picture" src="https://hillerliao.github.io/images/avatar.jpg">
					廖智海
				</a>
			</h1>
			<p class="lead"></p>
			<p class="lead"> </p>
			<p></p>
		</div>
			<ul class="sidebar-nav">
			</ul>
		<nav class="sidebar-social">
					<a class="sidebar-social-item" href="https://twitter.com/hillerliao" target="_blank">
						<i class="fa fa-twitter"></i>
					</a>
					<a class="sidebar-social-item" href="https://github.com/hillerliao" target="_blank">
						<i class="fa fa-github"></i>
					</a>
			<a class="sidebar-social-item" href="https://hillerliao.github.io/feeds/all.atom.xml">
				<i class="fa fa-rss"></i>
			</a>
		</nav>
	</div>
</div>		<div class="content container">
<div class="post">
	<h1 class="post-title">Termux 环境下 frpc 和 OpenClaw 服务保活方案</h1>
	<span class="post-date">Fri 13 February 2026</span>
	<h2>背景与痛点</h2>
<h3>问题场景</h3>
<p>在 Android 设备上运行 frpc（内网穿透客户端）和 OpenClaw 时，面临以下挑战：</p>
<ol>
<li><strong>手机重启后服务不自动启动</strong> - Android 系统不会自动运行 Termux 中的后台服务</li>
<li><strong>进程崩溃后不会重启</strong> - frpc 或 OpenClaw 可能因网络波动、内存不足等原因崩溃，需要手动介入</li>
<li><strong>无法方便地查看日志</strong> - 后台运行的进程没有会话管理，调试困难</li>
</ol>
<h3>需求</h3>
<ul>
<li>✅ 手机开机后 frpc + OpenClaw 自动启动</li>
<li>✅ 进程崩溃后自动检测并重启</li>
<li>✅ 方便查看运行日志</li>
<li>✅ 低资源占用（不频繁检测）</li>
</ul>
<hr>
<h2>方案概述</h2>
<p>利用 Termux 生态中的三个工具组合：</p>
<table>
<thead>
<tr>
<th>工具</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>termux:boot</strong></td>
<td>开机时自动执行脚本</td>
</tr>
<tr>
<td><strong>termux-wake-lock</strong></td>
<td>防止系统休眠杀死进程</td>
</tr>
<tr>
<td><strong>tmux</strong></td>
<td>会话管理（保持进程运行、方便查看日志）</td>
</tr>
<tr>
<td><strong>cron</strong></td>
<td>定时任务（每5分钟检测进程存活）</td>
</tr>
</tbody>
</table>
<hr>
<h2>依赖安装</h2>
<div class="highlight"><pre><span></span><code><span class="c1"># 安装 tmux（会话管理）</span>
pkg<span class="w"> </span>install<span class="w"> </span>tmux

<span class="c1"># 安装 cron（定时任务）</span>
pkg<span class="w"> </span>install<span class="w"> </span>crontab

<span class="c1"># 安装 termux:boot（开机自启）</span>
pkg<span class="w"> </span>install<span class="w"> </span>termux-boot
</code></pre></div>

<blockquote>
<p><strong>termux:boot 安装后需要在 Android 设置中授权自启动权限</strong></p>
</blockquote>
<hr>
<h2>脚本内容</h2>
<h3>1. OpenClaw 启动脚本 (<code>~/openclaw-run.sh</code>)</h3>
<p>负责清理旧进程、重新启动 OpenClaw：</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/data/data/com.termux/files/usr/bin/bash</span>
<span class="nb">set</span><span class="w"> </span>-e

<span class="nv">SESSION</span><span class="o">=</span><span class="s2">&quot;openclaw&quot;</span>
<span class="nv">PORT</span><span class="o">=</span><span class="s2">&quot;18789&quot;</span>
<span class="nv">NPM_BIN</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/.npm-global/bin&quot;</span>
<span class="nv">TOKEN_FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/.openclaw_token&quot;</span>

<span class="c1"># 基础检查</span>
<span class="k">if</span><span class="w"> </span>!<span class="w"> </span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>tmux<span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERR] tmux not found. Install: pkg install tmux&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$NPM_BIN</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERR] </span><span class="nv">$NPM_BIN</span><span class="s2"> not found&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TOKEN_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERR] token file not found: </span><span class="nv">$TOKEN_FILE</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

<span class="nv">TOKEN</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>cat<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TOKEN_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;\r &#39;</span><span class="k">)</span><span class="s2">&quot;</span>

mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/tmp&quot;</span>

<span class="c1"># 杀掉旧 session</span>
tmux<span class="w"> </span>kill-session<span class="w"> </span>-t<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SESSION</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
sleep<span class="w"> </span><span class="m">1</span>

<span class="c1"># 新建 session 并启动</span>
tmux<span class="w"> </span>new<span class="w"> </span>-d<span class="w"> </span>-s<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SESSION</span><span class="s2">&quot;</span>
sleep<span class="w"> </span><span class="m">1</span>

tmux<span class="w"> </span>send-keys<span class="w"> </span>-t<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SESSION</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="s2">&quot;export PATH=</span><span class="nv">$NPM_BIN</span><span class="s2">:\$PATH; export TMPDIR=\$HOME/tmp; export OPENCLAW_GATEWAY_TOKEN=&#39;</span><span class="nv">$TOKEN</span><span class="s2">&#39;; openclaw gateway --bind lan --port </span><span class="nv">$PORT</span><span class="s2"> --token \$OPENCLAW_GATEWAY_TOKEN --allow-unconfigured&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>C-m

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[OK] OpenClaw started in tmux session: </span><span class="nv">$SESSION</span><span class="s2">&quot;</span>
</code></pre></div>

<h3>2. 开机启动脚本 (<code>~/.termux/boot/services.sh</code>)</h3>
<p>手机开机时自动启动 crond、frpc 和 OpenClaw：</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/data/data/com.termux/files/usr/bin/bash</span>

<span class="c1"># 1. 清理旧会话</span>
tmux<span class="w"> </span>kill-session<span class="w"> </span>-t<span class="w"> </span>frpc<span class="w"> </span><span class="m">2</span>&gt;/dev/null
tmux<span class="w"> </span>kill-session<span class="w"> </span>-t<span class="w"> </span>openclaw<span class="w"> </span><span class="m">2</span>&gt;/dev/null
sleep<span class="w"> </span><span class="m">1</span>

<span class="c1"># 2. 启动 crond（关键）</span>
crond

<span class="c1"># 3. 启动 frpc（持有 wake lock）</span>
tmux<span class="w"> </span>new-session<span class="w"> </span>-d<span class="w"> </span>-s<span class="w"> </span>frpc<span class="w"> </span><span class="s2">&quot;exec /data/data/com.termux/files/usr/bin/frpc -c /data/data/com.termux/files/usr/etc/frp/frpc.ini&quot;</span>

<span class="c1"># 4. 启动 OpenClaw</span>
tmux<span class="w"> </span>new<span class="w"> </span>-d<span class="w"> </span>-s<span class="w"> </span>openclaw
sleep<span class="w"> </span><span class="m">1</span>
tmux<span class="w"> </span>send-keys<span class="w"> </span>-t<span class="w"> </span>openclaw<span class="w"> </span><span class="s2">&quot;export PATH=/data/data/com.termux/files/home/.npm-global/bin:\$PATH TMPDIR=\$HOME/tmp; export OPENCLAW_GATEWAY_TOKEN=tokenac27a3d5; openclaw gateway --bind lan --port 18789 --token \$OPENCLAW_GATEWAY_TOKEN --allow-unconfigured&quot;</span><span class="w"> </span>C-m
</code></pre></div>

<h3>3. frpc 启动脚本 (<code>~/.termux/boot/frpc-start.sh</code>)</h3>
<p>负责启动 frpc 并持有 wake lock：</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/data/data/com.termux/files/usr/bin/bash</span>
termux-wake-lock
<span class="nb">exec</span><span class="w"> </span>/data/data/com.termux/files/usr/bin/frpc<span class="w"> </span>-c<span class="w"> </span>/data/data/com.termux/files/usr/etc/frp/frpc.ini
</code></pre></div>

<blockquote>
<p><strong>关键点</strong>：使用 <code>exec</code> 前缀确保 wake lock 正确持有</p>
</blockquote>
<h3>4. 进程监控脚本 (<code>~/monitor.sh</code>)</h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/data/data/com.termux/files/usr/bin/bash</span>

<span class="nv">LOG_FILE</span><span class="o">=</span><span class="nv">$HOME</span>/monitor.log
<span class="nv">MAX_LOG_LINES</span><span class="o">=</span><span class="m">1000</span>

log<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[</span><span class="k">$(</span>date<span class="w"> </span><span class="s1">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="k">)</span><span class="s2">] </span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_FILE</span><span class="s2">&quot;</span>
<span class="o">}</span>

trim_log<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">lines</span><span class="o">=</span><span class="k">$(</span>wc<span class="w"> </span>-l<span class="w"> </span>&lt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="k">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$lines</span><span class="s2">&quot;</span><span class="w"> </span>-gt<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$MAX_LOG_LINES</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>tail<span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$MAX_LOG_LINES</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_FILE</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_FILE</span><span class="s2">.tmp&quot;</span>
<span class="w">        </span>mv<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_FILE</span><span class="s2">.tmp&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LOG_FILE</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="o">}</span>

log<span class="w"> </span><span class="s2">&quot;========== Monitor started ==========&quot;</span>

<span class="c1"># frpc 检测</span>
<span class="k">if</span><span class="w"> </span>!<span class="w"> </span>pgrep<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;frpc&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>log<span class="w"> </span><span class="s2">&quot;frpc 进程不存在，准备重启...&quot;</span>
<span class="w">    </span>tmux<span class="w"> </span>kill-session<span class="w"> </span>-t<span class="w"> </span>frpc<span class="w"> </span><span class="m">2</span>&gt;/dev/null
<span class="w">    </span>sleep<span class="w"> </span><span class="m">1</span>
<span class="w">    </span>tmux<span class="w"> </span>new-session<span class="w"> </span>-d<span class="w"> </span>-s<span class="w"> </span>frpc<span class="w"> </span><span class="s2">&quot;exec /data/data/com.termux/files/usr/bin/frpc -c /data/data/com.termux/files/usr/etc/frp/frpc.ini&quot;</span>
<span class="w">    </span>log<span class="w"> </span><span class="s2">&quot;frpc 重启命令已发送&quot;</span>
<span class="k">else</span>
<span class="w">    </span>log<span class="w"> </span><span class="s2">&quot;frpc 运行正常&quot;</span>
<span class="k">fi</span>

<span class="c1"># OpenClaw 检测</span>
<span class="k">if</span><span class="w"> </span>!<span class="w"> </span>pgrep<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;openclaw.*gateway&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>log<span class="w"> </span><span class="s2">&quot;OpenClaw 进程不存在，准备重启...&quot;</span>
<span class="w">    </span>bash<span class="w"> </span>~/openclaw-run.sh<span class="w"> </span>&gt;<span class="w"> </span>/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
<span class="w">    </span>sleep<span class="w"> </span><span class="m">3</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>pgrep<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;openclaw.*gateway&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>log<span class="w"> </span><span class="s2">&quot;OpenClaw 进程确认已启动&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span>log<span class="w"> </span><span class="s2">&quot;OpenClaw 启动验证失败&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="k">else</span>
<span class="w">    </span>log<span class="w"> </span><span class="s2">&quot;OpenClaw 运行正常&quot;</span>
<span class="k">fi</span>

trim_log
log<span class="w"> </span><span class="s2">&quot;========== Monitor finished ==========&quot;</span>
</code></pre></div>

<hr>
<h2>操作步骤</h2>
<h3>第一步：安装依赖</h3>
<div class="highlight"><pre><span></span><code>pkg<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>pkg<span class="w"> </span>install<span class="w"> </span>tmux<span class="w"> </span>crontab<span class="w"> </span>termux-api<span class="w"> </span>crond
</code></pre></div>

<h3>第二步：创建脚本文件</h3>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>~/.termux/boot
chmod<span class="w"> </span>+x<span class="w"> </span>~/.termux/boot/services.sh<span class="w"> </span>~/.termux/boot/frpc-start.sh<span class="w"> </span>~/openclaw-run.sh<span class="w"> </span>~/monitor.sh
</code></pre></div>

<h3>第三步：配置 cron</h3>
<div class="highlight"><pre><span></span><code>crontab<span class="w"> </span>-e
<span class="c1"># 添加以下内容（每5分钟检测一次）</span>
*/5<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>/data/data/com.termux/files/home/monitor.sh
</code></pre></div>

<hr>
<h2>常用命令</h2>
<table>
<thead>
<tr>
<th>操作</th>
<th>命令</th>
</tr>
</thead>
<tbody>
<tr>
<td>查看 tmux 会话</td>
<td><code>tmux ls</code></td>
</tr>
<tr>
<td>查看 frpc 日志</td>
<td><code>tmux attach -t frpc</code></td>
</tr>
<tr>
<td>查看 OpenClaw 日志</td>
<td><code>tmux attach -t openclaw</code></td>
</tr>
<tr>
<td>杀掉 tmux 会话</td>
<td><code>tmux kill-session -t frpc/openclaw</code></td>
</tr>
<tr>
<td>手动执行检测</td>
<td><code>bash ~/monitor.sh</code></td>
</tr>
<tr>
<td>查看监控日志</td>
<td><code>tail -f ~/monitor.log</code></td>
</tr>
</tbody>
</table>
<hr>
<h2>效果</h2>
<ul>
<li><strong>手机重启</strong> → crond + frpc + OpenClaw <strong>全部自动启动</strong></li>
<li><strong>进程崩溃</strong> → 5分钟内自动检测并重启</li>
<li><strong>随时查看日志</strong> → <code>tmux attach -t openclaw</code></li>
</ul>
<hr>
<h2>⚠️ 关键经验教训</h2>
<ol>
<li><strong>termux:boot 只在开机时执行一次</strong>，杀进程后不会自动重启</li>
<li><strong>boot 脚本不能用环境变量</strong>，必须硬编码 token 和 port</li>
<li><strong>crond 必须加入 boot 脚本</strong>，否则进程监控不生效</li>
<li><strong>monitor.sh 用绝对路径</strong>，cron 环境下 $PREFIX 不生效</li>
<li><strong>frpc 用 exec 启动</strong>，确保 wake lock 正确持有</li>
</ol>
<hr>
<h2>参考资源</h2>
<ul>
<li><a href="https://wiki.termux.com/wiki/Termux:Boot">Termux Wiki - Boot</a></li>
<li><a href="https://wiki.termux.com/wiki/Cron">Termux Wiki - Cron</a></li>
<li><a href="https://tmuxcheatsheet.com/">Tmux 常用命令</a></li>
</ul>


</div>
		</div>
	</body>
</html>